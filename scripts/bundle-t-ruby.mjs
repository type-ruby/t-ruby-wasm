#!/usr/bin/env node

/**
 * Bundle T-Ruby source files into a TypeScript module
 *
 * This script reads all Ruby files from vendor/t-ruby and generates
 * a TypeScript file that embeds them for use in the WASM environment.
 */

import { readFileSync, writeFileSync, existsSync, readdirSync, statSync } from "node:fs";
import { dirname, join, relative } from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = join(__dirname, "..");
const vendorDir = join(rootDir, "vendor", "t-ruby");
const outputFile = join(rootDir, "src", "vm", "TRubyBundle.ts");

/**
 * Recursively collect all .rb files from a directory
 */
function collectRubyFiles(dir, basePath = "") {
  const files = [];

  if (!existsSync(dir)) {
    return files;
  }

  for (const entry of readdirSync(dir)) {
    const fullPath = join(dir, entry);
    const relativePath = basePath ? `${basePath}/${entry}` : entry;

    if (statSync(fullPath).isDirectory()) {
      files.push(...collectRubyFiles(fullPath, relativePath));
    } else if (entry.endsWith(".rb")) {
      files.push({
        path: relativePath,
        content: readFileSync(fullPath, "utf-8"),
      });
    }
  }

  return files;
}

/**
 * Escape string for use in TypeScript template literal
 */
function escapeForTemplate(str) {
  return str
    .replace(/\\/g, "\\\\")
    .replace(/`/g, "\\`")
    .replace(/\$\{/g, "\\${");
}

console.log("Bundling T-Ruby source files...");

const files = collectRubyFiles(vendorDir);

if (files.length === 0) {
  console.log("No Ruby files found in vendor/t-ruby. Using fallback bundle.");

  // Generate fallback bundle (minimal implementation)
  const fallbackContent = `/**
 * T-Ruby Bundle - Auto-generated
 *
 * This file contains bundled T-Ruby source files for WASM environment.
 * Generated at build time from vendor/t-ruby directory.
 *
 * @internal
 */

/** Bundled T-Ruby source files */
export const T_RUBY_BUNDLE: Record<string, string> = {};

/** Flag indicating if real T-Ruby is bundled */
export const HAS_T_RUBY_BUNDLE = false;
`;

  writeFileSync(outputFile, fallbackContent);
  console.log("Generated fallback bundle.");
} else {
  console.log(`Found ${files.length} Ruby files to bundle.`);

  // Generate TypeScript bundle
  let content = `/**
 * T-Ruby Bundle - Auto-generated
 *
 * This file contains bundled T-Ruby source files for WASM environment.
 * Generated at build time from vendor/t-ruby directory.
 *
 * DO NOT EDIT MANUALLY - This file is auto-generated by scripts/bundle-t-ruby.mjs
 *
 * @internal
 */

/** Bundled T-Ruby source files */
export const T_RUBY_BUNDLE: Record<string, string> = {
`;

  for (const file of files) {
    content += `  "${file.path}": \`${escapeForTemplate(file.content)}\`,\n`;
  }

  content += `};

/** Flag indicating if real T-Ruby is bundled */
export const HAS_T_RUBY_BUNDLE = true;
`;

  writeFileSync(outputFile, content);
  console.log(`Generated bundle with ${files.length} files: ${outputFile}`);
}
